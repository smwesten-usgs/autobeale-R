<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Steve Westenbroek" />

<meta name="date" content="2017-02-22" />

<title>Introduction to autobeale</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">Introduction to autobeale</h1>
<h4 class="author"><em>Steve Westenbroek</em></h4>
<h4 class="date"><em>2017-02-22</em></h4>



<div id="overview" class="section level2">
<h2>Overview</h2>
<p>This document demonstrates the basic use of the autobeale package. The code is broken into a number of discrete functions, which may be thought of as pertaining to either the Beale calculation itself, or else to the partitioning and stratification of the dataset <em>prior</em> to calculation with the Beale method.</p>
</div>
<div id="background" class="section level2">
<h2>Background</h2>
<p>The Beale Ratio Estimator has been used in numerous nutrient and pollutant loading studies, particularly for load estimates to the Great Lakes. The <code>autobeale</code> package traces its roots back earlier versions of software aimed at making these calculations easier. Peter Richards, the author of an earlier <code>AutoBeale</code> code has written about the evolution of Beale software over the years:</p>
<blockquote>
<p>The Beale Ratio Estimator is described in Tin (1965). It has been widely used for computation of substance loadings to receiving waters, particularly in the Great Lakes system. The initial code was developed by Ken Baun of Wisconsin DNR (1982). It was subsequently used and developed by Kevin McGunagle at the International Joint Commission (IJC), from whom the current version was received. It was then developed in the 1990’s by Pete Richards at the National Center for Water Quality Research at Heidelberg University (www.heidelberg.edu/academiclife/distinctive/ncwqr). Peter developed the code to work with the Macintosh computer of the time (“Motorola” architecture, which was replaced by Intel architecture ca. 2005), and included a Graphic User Interface (GUI) and an algorithm that objectively and sequentially searched out the best stratification given the data, with “best” being defined as minimizing the root-mean-square error (RMSE) given the data at hand.</p>
</blockquote>
</div>
<div id="example-dataset" class="section level2">
<h2>Example dataset</h2>
<p>This set of example applications demonstrates various approaches to estimation of nitrate-nitrite loads in kilograms in the Rocky River near Cleveland, Ohio. After loading the <code>autobeale</code> library as well as Hadly Wickham’s excellent <code>dplyr</code> library, the data is read in from two simple tab-delimited text files.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(autobeale)
<span class="kw">library</span>(dplyr)
<span class="kw">library</span>(mcga)</code></pre></div>
<p>The <code>autobeale::beale</code> function expects the incoming data to be provided in pairwise fashion. There should be a discharge value provided for <em>every</em> day within the timeframe for the laoding calculation, with a concentration value provided on days that were sampled. <code>dplyr::left_join</code> can be used to quickly create an input dataset suitable for use with the <code>beale</code> function.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">discharge_file     &lt;-<span class="st"> </span><span class="kw">system.file</span>( <span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;ROCKFLOW.DAT&quot;</span>, <span class="dt">package=</span><span class="st">&quot;autobeale&quot;</span>)
concentration_file &lt;-<span class="st"> </span><span class="kw">system.file</span>( <span class="st">&quot;extdata&quot;</span>, <span class="st">&quot;ROCKNO23.DAT&quot;</span>, <span class="dt">package=</span><span class="st">&quot;autobeale&quot;</span>)

discharge_data     &lt;-<span class="st"> </span><span class="kw">read.table</span>( discharge_file, <span class="dt">header=</span><span class="ot">TRUE</span> )
concentration_data &lt;-<span class="st"> </span><span class="kw">read.table</span>( concentration_file, <span class="dt">header=</span><span class="ot">TRUE</span> )
qcdata &lt;-<span class="st"> </span>dplyr::<span class="kw">left_join</span>(discharge_data, concentration_data, <span class="dt">by=</span><span class="kw">c</span>(<span class="st">&quot;date&quot;</span> =<span class="st"> &quot;date&quot;</span>) )

<span class="co"># don't forget to convert the discharge value to cubic meters per second!</span>
qcdata$discharge &lt;-<span class="st"> </span><span class="kw">cfs_to_cms</span>( qcdata$discharge )</code></pre></div>
<p>The resulting dataframe looks like this:</p>
<table>
<thead>
<tr class="header">
<th align="right">date</th>
<th align="right">discharge</th>
<th align="right">concentration</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">970101</td>
<td align="right">0.3114853</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">970102</td>
<td align="right">0.2831685</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">970103</td>
<td align="right">0.3114853</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">970104</td>
<td align="right">0.3398022</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">970105</td>
<td align="right">1.4724760</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">970106</td>
<td align="right">1.3592086</td>
<td align="right">4.7</td>
</tr>
<tr class="odd">
<td align="right">970107</td>
<td align="right">0.3681190</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">970108</td>
<td align="right">0.1982179</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="right">970109</td>
<td align="right">0.1699011</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="right">970110</td>
<td align="right">0.1529110</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
</div>
<div id="example-1-load-by-means-of-the-unstratified-beale-ratio-estimator" class="section level2">
<h2>Example #1: load by means of the unstratified Beale ratio estimator</h2>
<p>Note that the <code>beale</code> function expects discharge to be provided in units of <em>cubic meters per second</em>, with concentration data provided in units of <em>milligrams per liter</em>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">result_list &lt;-<span class="st"> </span><span class="kw">beale</span>( <span class="dt">discharge_cms=</span>qcdata$discharge /<span class="st"> </span><span class="fl">35.3146</span>, <span class="dt">conc_mg_L=</span>qcdata$concentration )
<span class="kw">print</span>( result_list )</code></pre></div>
<p>$load_total_corrected [1] 5157.6</p>
<p>$load_daily_corrected [1] 14.13033</p>
<p>$load_mean [1] 14.61638</p>
<p>$load_daily [1] 15.62944067 1.07244566 0.73713319 2.52177146 2.23772577 [6] 2.07838307 1.09115111 8.31353227 22.84835786 28.65397456 [11] 5.67398577 2.14766250 26.82499746 3.06215105 16.76562341 [16] 4.21218968 1.17775040 6.84480824 1.75276972 19.12112422 [21] 296.43284898 198.40244763 3.78265718 1.61074688 1.67656234 [26] 48.96670507 1.15280981 1.58927025 0.44893074 0.27434656 [31] 0.60965903 0.13301652 8.35509993 0.54938592 0.13578769 [36] 0.09144885 0.10184077 1.41122210 0.09422003 0.02216942 [41] 0.00000000 0.00000000 0.07066502 0.00000000 0.02424780 [46] 0.02632619 0.20783831 8.47980292 2.18715178 3.25613347 [51] 1.68349028 5.50771513</p>
<p>$confidence_interval [1] 1727.059</p>
<p>$discharge_mean [1] 0.03340202</p>
<p>$discharge_mean_sample_days_only [1] 0.03507611</p>
<p>$mse [1] 740060.5</p>
<p>$rmse [1] 860.268</p>
<p>$df [1] 51</p>
<p>$n_conc [1] 52</p>
<p>$n_discharge [1] 365</p>
</div>
<div id="example-2-beale-ratio-estimator-with-data-partitioned-into-five-stratums" class="section level2">
<h2>Example #2: Beale Ratio Estimator with data partitioned into five stratums</h2>
<p>In addition to the <code>beale</code> function are a number of <code>R6</code> classes aimed at making it easier to examine various data partitioning strategies. Strategies may be ranked by their impact on the root mean square of error associated with the load estimate. In this example, a genetic algorithm package is wired up to assist in the search for an optimum partitioning strategy, with optimimum being defined as minimization of the root mean square of error associated with the overall loading estimate, similar to the original AutoBeale.</p>
<p>In order to use these classes, real R date classes (POSIX) must be supplied along with the discharge and concentration data. Another of Hadley Wickham’s library packages, <code>lubridate</code>, makes this easy:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(lubridate)

qcdata$date &lt;-<span class="st"> </span>lubridate::<span class="kw">ymd</span>( qcdata$date )</code></pre></div>
<p>The <code>qcdata</code> dataframe now looks like this:</p>
<table>
<thead>
<tr class="header">
<th align="left">date</th>
<th align="right">discharge</th>
<th align="right">concentration</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1997-01-01</td>
<td align="right">0.3114853</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">1997-01-02</td>
<td align="right">0.2831685</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">1997-01-03</td>
<td align="right">0.3114853</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">1997-01-04</td>
<td align="right">0.3398022</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">1997-01-05</td>
<td align="right">1.4724760</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">1997-01-06</td>
<td align="right">1.3592086</td>
<td align="right">4.7</td>
</tr>
<tr class="odd">
<td align="left">1997-01-07</td>
<td align="right">0.3681190</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">1997-01-08</td>
<td align="right">0.1982179</td>
<td align="right">NA</td>
</tr>
<tr class="odd">
<td align="left">1997-01-09</td>
<td align="right">0.1699011</td>
<td align="right">NA</td>
</tr>
<tr class="even">
<td align="left">1997-01-10</td>
<td align="right">0.1529110</td>
<td align="right">NA</td>
</tr>
</tbody>
</table>
<p>First we creata a <code>strata</code> object of the appropriate size (5 stratums):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">number_of_stratums &lt;-<span class="st"> </span><span class="dv">5</span>
mystrata &lt;-<span class="st"> </span>strata$<span class="kw">new</span>( number_of_stratums, qcdata )</code></pre></div>
<p>Next we wire up a genetic algoritm package to test alternative partitioning strategies. Package <code>mcga</code> uses its <code>evalFunc</code> argument to pass a vector of fractions that define the partitioning scheme to the <code>strata</code> object, which evaluates the Beale load and returns the associated RMSE estimate.</p>
<p>The genetic algorithm package, in turn, compares the current RMSE value with other previously calculated values (associated with other partitioning strategies), and ‘evolves’ a new partitioning strategy to test. This process is repeated hundreds or thousands of times in an attempt to find a optimum partitioning strategy.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> m &lt;-<span class="st"> </span><span class="kw">mcga</span>( <span class="dt">popsize=</span><span class="dv">200</span>,
            <span class="dt">chsize=</span><span class="dv">4</span>,
            <span class="dt">minval=</span><span class="fl">0.0</span>,
            <span class="dt">maxval=</span><span class="fl">1.0</span>,
            <span class="dt">elitism=</span><span class="dv">10</span>,
            <span class="dt">maxiter=</span><span class="dv">40</span>,
            <span class="dt">crossprob=</span><span class="fl">1.0</span>,
            <span class="dt">mutateprob=</span><span class="fl">0.05</span>,
            <span class="dt">evalFunc=</span>mystrata$update_rmse )

 <span class="kw">cat</span>(<span class="st">&quot;Best chromosome:</span><span class="ch">\n</span><span class="st">&quot;</span>)</code></pre></div>
<pre><code>## Best chromosome:</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> <span class="kw">cat</span>(m$population[<span class="dv">1</span>,],<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</code></pre></div>
<pre><code>## 0.3580313 0.5486861 0.4065568 0.490678</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"> <span class="kw">cat</span>(<span class="st">&quot;Cost: &quot;</span>,m$costs[<span class="dv">1</span>],<span class="st">&quot;</span><span class="ch">\n</span><span class="st">&quot;</span>)</code></pre></div>
<pre><code>## Cost:  10393.85</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># create a copy of the strata object</span>
best_strata &lt;-<span class="st"> </span>mystrata$<span class="kw">clone</span>()

<span class="co"># rerun with the optimized parameter</span>
best_strata$partitions$<span class="kw">update</span>( <span class="kw">sort</span>( m$population[ <span class="dv">1</span>, ]) )
best_strata$<span class="kw">rearrange_stratums</span>( best_strata$partitions$<span class="kw">get_date_values</span>() )

best_strata$<span class="kw">calc_loads</span>()
results_df &lt;-<span class="st"> </span>best_strata$<span class="kw">summarize_results</span>()

<span class="co"># round values to produce a more readable table</span>
results_df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="kw">lapply</span>(results_df, function(y) if(<span class="kw">is.numeric</span>(y)) <span class="kw">round</span>(y, <span class="dv">2</span>) else y)) </code></pre></div>
<p>The results of the load calculation with optimum stratification using 5 stratums now looks like this:</p>
<table>
<thead>
<tr class="header">
<th align="left">stratum</th>
<th align="left">from_date</th>
<th align="left">to_date</th>
<th align="right">n_conc</th>
<th align="right">n_q</th>
<th align="right">q_mean</th>
<th align="right">q_mean__sample_days</th>
<th align="right">mse</th>
<th align="right">rmse</th>
<th align="right">df</th>
<th align="right">load_total</th>
<th align="right">ci</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">1</td>
<td align="left">1997-01-01</td>
<td align="left">1997-05-11</td>
<td align="right">18</td>
<td align="right">131</td>
<td align="right">1.64</td>
<td align="right">0.86</td>
<td align="right">21007209.8</td>
<td align="right">4583.36</td>
<td align="right">1.7e+01</td>
<td align="right">75880.4</td>
<td align="right">9.670050e+03</td>
</tr>
<tr class="even">
<td align="left">2</td>
<td align="left">1997-05-12</td>
<td align="left">1997-05-29</td>
<td align="right">3</td>
<td align="right">18</td>
<td align="right">3.03</td>
<td align="right">6.55</td>
<td align="right">78370259.1</td>
<td align="right">8852.70</td>
<td align="right">2.0e+00</td>
<td align="right">21452.3</td>
<td align="right">3.809008e+04</td>
</tr>
<tr class="odd">
<td align="left">3</td>
<td align="left">1997-05-30</td>
<td align="left">1997-06-29</td>
<td align="right">4</td>
<td align="right">31</td>
<td align="right">2.87</td>
<td align="right">4.96</td>
<td align="right">1191597.5</td>
<td align="right">1091.60</td>
<td align="right">3.0e+00</td>
<td align="right">22872.5</td>
<td align="right">3.473970e+03</td>
</tr>
<tr class="even">
<td align="left">4</td>
<td align="left">1997-06-30</td>
<td align="left">1997-07-20</td>
<td align="right">3</td>
<td align="right">21</td>
<td align="right">0.95</td>
<td align="right">1.28</td>
<td align="right">514202.7</td>
<td align="right">717.08</td>
<td align="right">2.0e+00</td>
<td align="right">8293.9</td>
<td align="right">3.085340e+03</td>
</tr>
<tr class="odd">
<td align="left">5</td>
<td align="left">1997-07-21</td>
<td align="left">1997-12-31</td>
<td align="right">24</td>
<td align="right">164</td>
<td align="right">0.32</td>
<td align="right">0.24</td>
<td align="right">6948805.6</td>
<td align="right">2636.06</td>
<td align="right">2.3e+01</td>
<td align="right">11130.1</td>
<td align="right">5.453100e+03</td>
</tr>
<tr class="even">
<td align="left">all strata</td>
<td align="left">1997-01-01</td>
<td align="left">1997-12-31</td>
<td align="right">52</td>
<td align="right">365</td>
<td align="right">1.18</td>
<td align="right">1.24</td>
<td align="right">108032074.8</td>
<td align="right">10393.85</td>
<td align="right">1.0e+23</td>
<td align="right">139629.2</td>
<td align="right">1.000000e+23</td>
</tr>
</tbody>
</table>
</div>
<div id="original-autobeale-results-for-the-same-data-file" class="section level2">
<h2>Original AutoBeale results for the same data file</h2>
<p>For reference, here are the summarized results generated by Peter Richard’s original AutoBeale code:</p>
<hr />
<pre><code>Stratification applied:

block  stratum   start      end   

1       1     19970101 19970420
2       2     19970421 19970526
3       3     19970527 19970817
4       4     19970818 19971201
5       5     19971202 19971231


Summary over 5 strata:

Mean daily loading:      
                         459187.6  g/day
                      167603487.   g/year
                         167603.4  kg/year

Mean square error:   893200710.529 ( g/day)**2
                     118996664.660 (kg/year)**2

based on     9.348 degrees of freedom
The 95% confidence interval half-width is       24539.3375 kg/year</code></pre>
<hr />
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
